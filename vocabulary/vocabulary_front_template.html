<div id="word" style="margin-bottom: 30px;">{{Front}}</div>

<div id="sentences" style="margin-bottom: 30px; background-color:#D3A3A9;"></div>

<div>
  <button id="button" style="width: 80vw; height: 50px;">
    Show Translation
  </button>
</div>

<script>
  async function getCompletionFromMessage(messages) {
    const response = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: "Bearer sk-",
      },
      body: JSON.stringify({
        model: "gpt-3.5-turbo",
        messages: messages,
      }),
    });
    const data = await response.json();
    return data.choices[0].message.content;
  }

  function speech(text) {
    // var msg = new SpeechSynthesisUtterance();
    // // var voices = window.speechSynthesis.getVoices();
    // // msg.voice = voices[10]; 
    // msg.voice = window.speechSynthesis.getVoices()[109];
    // // msg.volume = 1; // From 0 to 1
    // msg.rate = 0.9; // From 0.1 to 10
    // // msg.pitch = 2; // From 0 to 2
    // msg.text = text;
    // // msg.lang = 'en';
    // speechSynthesis.speak(msg);
  }

  async function main() {
    var word = "{{Front}}";
    var prompt;
    var messages = [];
    var response;

    prompt = `Make a sentence using this English word "${word}". If the word has more than one common meaning, please make a sentence for each of the top two most prevalent meanings. Present your responses in JSON format, using 'sentences' as the key.`;
    messages.push({ role: "user", content: prompt })
    response = await getCompletionFromMessage(messages);
    var sentences_json_string = response.substring(response.indexOf("{"), response.lastIndexOf("}") + 1)
    console.log("sentences: " + sentences_json_string);
    var sentences = JSON.parse(sentences_json_string);
    if (document.getElementById("word").innerText != word) { // check whether the same card, due to async
      return;
    }
    document.getElementById("sentences").innerText = sentences.sentences.join("\n\n");
    for (let i = 0; i < sentences.sentences.length; i++) {
      speech(sentences.sentences[i]);
      if (i < sentences.sentences.length - 1) {
        await new Promise(r => setTimeout(r, 2000));
      }
    }

    prompt = `Translate the sentences from English to Chinese. Output your translations in JSON format, using 'translations' as the key and a list of your translated sentences as the corresponding value.`;
    messages.push({ role: "assistant", content: response});
    messages.push({ role: "user", content: prompt});
    response = await getCompletionFromMessage(messages);
    var translations_json_string = response.substring(response.indexOf("{"), response.lastIndexOf("}") + 1)
    console.log("translations: " + translations_json_string);
    var translations = JSON.parse(translations_json_string);

    var clickEvent = () => {
      if (document.getElementById("word").innerText != word) {
        return;
      }
      var combined = [];
      for(let i = 0; i < sentences.sentences.length; i++){
        combined.push(sentences.sentences[i]);
        combined.push(translations.translations[i]);
      }
      document.getElementById("sentences").innerText = combined.join("\n\n");
      document.getElementById("button").remove();
    };

    document.getElementById("button").addEventListener("click", clickEvent);
  }

  // Call the main function to start
  main();

</script>